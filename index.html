<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mobile Vinyl Record Player with Album Cover – Improved</title>
  <base href="https://virtualtracks.com/" />
  <style>
    :root { --bg:#2c3e50; --panel:#34495e; --brand:#3498db; --text:#ecf0f1; --muted:#bdc3c7; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); overflow:hidden; transition: background 200ms ease; }
    .container { display:flex; flex-direction:column; height:100%; }

    /* Tabs */
    .tab-buttons { display:flex; background:var(--panel); gap:2px; align-items:center; }
    .tab-button { flex:1; padding:14px; background:transparent; border:0; color:var(--text); font-size:14px; cursor:pointer; transition: background .2s; }
    .tab-button.active, .tab-button:focus-visible { background:var(--brand); outline:none; }

    .tab-content { flex:1; overflow:auto; padding:16px; display:none; }
    .tab-content.active { display:block; }

    h1 { margin: 8px 0 16px; color:var(--brand); font-size:22px; text-align:center; }

    /* Turntable */
    .player-wrap { display:grid; place-items:center; gap:16px; }
    .turntable { width:min(82vw,82vh); height:min(82vw,82vh); background:var(--panel); border-radius:50%; position:relative; overflow:hidden; box-shadow:0 0 24px rgba(0,0,0,.35); }
    .record { width:100%; height:100%; position:absolute; inset:0; border-radius:50%; background:#000; overflow:hidden; transform:rotate(0deg); will-change:transform; }
    .grooves { position:absolute; inset:0; background-image:repeating-radial-gradient(circle at center, #000 0px, #000 2px, #222 2px, #222 4px); opacity:.7; }
    .label { width:40%; height:40%; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); border-radius:50%; background-size:cover; background-position:center; background-color:var(--muted); display:flex; justify-content:center; align-items:center; font-size:14px; color:#2c3e50; text-align:center; padding:6px; }
    .spindle { width:2.7%; aspect-ratio:1/1; background:var(--text); border-radius:50%; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); box-shadow:inset 0 0 4px rgba(0,0,0,.4); }

    /* Tonearm (simple) */
    .tonearm { position:absolute; width:45%; height:4px; background:#999; top:10%; right:5%; transform-origin:95% 50%; transform:rotate(25deg); border-radius:2px; box-shadow:0 0 4px rgba(0,0,0,.4); }
    .tonearm::after { content:""; position:absolute; right:-6px; top:-4px; width:14px; height:12px; background:#ccc; border-radius:2px; }

    .controls { margin-top:6px; display:flex; flex-wrap:wrap; justify-content:center; gap:8px; }
    button, .control { font-size:16px; padding:10px 14px; border:0; border-radius:8px; background:var(--brand); color:white; cursor:pointer; }
    button:hover { filter:brightness(.95); }
    button.secondary { background:#586f7c; }

    .sliders { display:flex; gap:16px; flex-wrap:wrap; justify-content:center; align-items:center; }
    .sliders label { font-size:12px; opacity:.9; display:flex; gap:8px; align-items:center; }

    input[type="range"] { width:200px; }

    /* Album cover + waveform */
    .album-cover { width:min(82vw,82vh); height:min(82vw,82vh); margin:0 auto; position:relative; overflow:hidden; border-radius:12px; box-shadow:0 0 24px rgba(0,0,0,.35); background:#1f2a36; }
    .album-image { width:100%; height:100%; object-fit:cover; display:block; }
    /* FULL-COVER WAVEFORM CANVAS */
    .waveform { position:absolute; inset:0; width:100%; height:100%; z-index:10; pointer-events:none; }

    .file-input { display:flex; flex-direction:column; align-items:flex-start; margin:10px 0; gap:6px; }
    .file-input input[type="file"] { display:block; padding:6px; background:var(--panel); border:1px solid var(--brand); border-radius:6px; color:var(--text); font-size:14px; width:100%; }

    .instructions { margin-top:14px; text-align:left; background:var(--panel); padding:12px 14px; border-radius:10px; font-size:14px; }
    .instructions h2 { color:var(--brand); margin:0 0 8px; font-size:18px; }

    .visually-hidden { position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }
  </style>
</head>
<body>
  <div class="container">
    <div class="tab-buttons" role="tablist" aria-label="Player tabs">
      <button class="tab-button active" data-tab="player" role="tab" aria-selected="true">Player</button>
      <button class="tab-button" data-tab="album" role="tab" aria-selected="false">Album Cover</button>
      <button class="tab-button" data-tab="upload" role="tab" aria-selected="false">Upload & Instructions</button>
    </div>

    <!-- PLAYER TAB -->
    <section class="tab-content active" id="player-tab" role="tabpanel" aria-labelledby="player">
      <h1>Mobile Vinyl Record Player</h1>
      <div class="player-wrap">
        <div class="turntable">
          <div class="record" aria-label="Vinyl record">
            <div class="grooves" aria-hidden="true"></div>
            <div class="label">Upload a label image</div>
            <div class="spindle" aria-hidden="true"></div>
          </div>
          <div class="tonearm" aria-hidden="true"></div>
        </div>
        <div class="controls" aria-label="Playback controls">
          <button id="playPause" aria-pressed="false">Play</button>
          <button id="stop" class="secondary">Stop</button>
          <button id="rewind" class="secondary" title="Rewind 10s">⏪ 10s</button>
          <button id="forward" class="secondary" title="Forward 10s">⏩ 10s</button>
          <button id="discoBtn" class="secondary" title="Toggle disco lights">Disco lights: Off</button>
        </div>
        <div class="sliders">
          <label>Volume <input id="volume" type="range" min="0" max="1" step="0.01" value="0.9"></label>
          <label>Speed 33⇄45 <input id="speed" type="range" min="0.75" max="1.35" step="0.01" value="1.00"></label>
          <label>Label size <input id="resizeSlider" type="range" min="20" max="80" value="40"></label>
          <span id="resizeValue" aria-live="polite">40%</span>
        </div>
        <div class="sliders" style="width:min(82vw,82vh);">
          <label class="progress" style="flex:1;">Progress
            <input id="progress" type="range" min="0" max="1000" step="1" value="0" style="width:100%;">
          </label>
          <span id="timeReadout" aria-live="polite">00:00 / 00:00</span>
        </div>
      </div>
    </section>

    <!-- ALBUM TAB -->
    <section class="tab-content" id="album-tab" role="tabpanel" aria-labelledby="album">
      <h1>Album Cover</h1>
      <div class="album-cover">
        <img class="album-image" alt="Album cover" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" />
        <canvas class="waveform"></canvas>
      </div>
      <div class="controls" aria-label="Playback controls (album)">
        <button id="albumPlayPause" aria-pressed="false">Play</button>
        <button id="albumStop" class="secondary">Stop</button>
        <label class="control" style="background:#586f7c; display:flex; align-items:center; gap:8px;">
          Mode
          <select id="waveMode" style="border:0; border-radius:6px; padding:6px; background:#1f2a36; color:#ecf0f1;">
            <option value="horizontal" selected>Horizontal (centre)</option>
            <option value="bottom">Horizontal (bottom)</option>
            <option value="circle">Circle</option>
            <option value="bars">Bars</option>
          </select>
        </label>
      </div>
    </section>

    <!-- UPLOAD TAB -->
    <section class="tab-content" id="upload-tab" role="tabpanel" aria-labelledby="upload">
      <h1>Upload Music & Images</h1>
      <div class="file-input">
        <label for="audioUpload"><strong>Upload your music</strong></label>
        <input id="audioUpload" type="file" accept="audio/*" />
        <small>MP3/M4A/WAV recommended</small>
      </div>
      <div class="file-input">
        <label for="labelImageUpload"><strong>Upload label image</strong></label>
        <input id="labelImageUpload" type="file" accept="image/*" />
      </div>
      <div class="file-input">
        <label for="albumCoverUpload"><strong>Upload album cover</strong></label>
        <input id="albumCoverUpload" type="file" accept="image/*" />
      </div>
      <div class="instructions">
        <h2>How to use</h2>
        <ol>
          <li>Upload an audio file.</li>
          <li>Upload a label image (optional) and adjust size.</li>
          <li>Upload an album cover (optional).</li>
          <li>Use Play / Stop. Scrub the progress bar to seek.</li>
          <li>Switch tabs any time; the music keeps playing.</li>
        </ol>
      </div>
    </section>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Elements
      const record = document.querySelector('.record');
      const label = document.querySelector('.label');
      const playPauseBtn = document.getElementById('playPause');
      const stopBtn = document.getElementById('stop');
      const rewindBtn = document.getElementById('rewind');
      const forwardBtn = document.getElementById('forward');
      const discoBtn = document.getElementById('discoBtn');
      const audioUpload = document.getElementById('audioUpload');
      const labelImageUpload = document.getElementById('labelImageUpload');
      const albumCoverUpload = document.getElementById('albumCoverUpload');
      const resizeSlider = document.getElementById('resizeSlider');
      const resizeValue = document.getElementById('resizeValue');
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabContents = document.querySelectorAll('.tab-content');
      const albumImage = document.querySelector('.album-image');
      const waveformCanvas = document.querySelector('.waveform');
      const waveformCtx = waveformCanvas.getContext('2d');
      const vol = document.getElementById('volume');
      const speed = document.getElementById('speed');
      const progress = document.getElementById('progress');
      const timeReadout = document.getElementById('timeReadout');
      const albumPlayPauseBtn = document.getElementById('albumPlayPause');
      const albumStopBtn = document.getElementById('albumStop');
      const waveMode = document.getElementById('waveMode');

      // Audio
      const audio = new Audio();
      audio.preload = 'metadata';
      audio.crossOrigin = 'anonymous';
      audio.volume = parseFloat(vol.value);
      let audioContext, analyser, sourceNode, dataArray;
      let isPlaying = false; let rotation = 0; let animId; let wfId; let hue = 0; let discoId; let discoOn = false;

      function ensureAC() {
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          analyser = audioContext.createAnalyser();
          analyser.fftSize = 2048;
          const bufferLen = analyser.frequencyBinCount;
          dataArray = new Uint8Array(bufferLen);
          sourceNode = audioContext.createMediaElementSource(audio);
          sourceNode.connect(analyser);
          analyser.connect(audioContext.destination);
        }
      }

      // Rotation
      function rotateRecord() {
        rotation = (rotation + (parseFloat(speed.value) * 0.5));
        record.style.transform = `rotate(${rotation}deg)`;
        animId = requestAnimationFrame(rotateRecord);
      }
      function stopRotation() { cancelAnimationFrame(animId); }

      // Waveform
      function drawWaveform() {
        if (!analyser || !dataArray) return;
        const width = waveformCanvas.width = waveformCanvas.clientWidth;
        const height = waveformCanvas.height = waveformCanvas.clientHeight;

        const mode = waveMode ? waveMode.value : 'horizontal';

        waveformCtx.clearRect(0, 0, width, height);
        waveformCtx.lineWidth = 3;
        waveformCtx.strokeStyle = `hsl(${hue}, 100%, 50%)`;

        if (mode === 'bars') {
          // ---- BARS MODE (clear & bold) ----
          const freqArray = new Uint8Array(analyser.frequencyBinCount);
          analyser.getByteFrequencyData(freqArray);

          const BAR_COUNT = 64; // bold display
          const bucket = Math.max(1, Math.floor(freqArray.length / BAR_COUNT));
          const bandW = width / BAR_COUNT;
          const gap = Math.max(1, Math.floor(bandW * 0.12));
          const barW = Math.max(1, Math.floor(bandW - gap));
          const baseline = Math.floor(height * 0.92);

          const prevComp = waveformCtx.globalCompositeOperation;
          waveformCtx.globalCompositeOperation = 'screen';

          for (let b = 0; b < BAR_COUNT; b++) {
            let sum = 0;
            const start = b * bucket;
            for (let j = 0; j < bucket; j++) sum += freqArray[start + j] || 0;
            const avg = sum / bucket; // 0..255
            const barH = Math.max(2, (avg / 255) * (height * 0.75));
            const x = Math.floor(b * bandW + gap / 2);
            const y = baseline - barH;
            waveformCtx.fillStyle = `hsl(${(hue + b * 4) % 360}, 100%, 55%)`;
            waveformCtx.fillRect(x, y, barW, barH);
          }

          waveformCtx.globalCompositeOperation = prevComp;
        } else if (mode === 'circle') {
          // Circular oscilloscope
          analyser.getByteTimeDomainData(dataArray);
          const cx = width / 2, cy = height / 2;
          const radius = Math.min(width, height) * 0.28;
          waveformCtx.beginPath();
          for (let i = 0; i < dataArray.length; i++) {
            const t = (i / dataArray.length) * Math.PI * 2;
            const v = (dataArray[i] - 128) / 128; // -1..1
            const r = radius + v * radius * 0.35;
            const x = cx + Math.cos(t) * r;
            const y = cy + Math.sin(t) * r;
            if (i === 0) waveformCtx.moveTo(x, y); else waveformCtx.lineTo(x, y);
          }
          waveformCtx.closePath();
          waveformCtx.stroke();
        } else {
          // Horizontal line (centre or bottom)
          analyser.getByteTimeDomainData(dataArray);
          waveformCtx.beginPath();
          const slice = width / dataArray.length; let x = 0;
          const baseline = (mode === 'bottom') ? height * 0.85 : height / 2; // centre by default
          for (let i = 0; i < dataArray.length; i++) {
            const v = (dataArray[i] - 128) / 128; // -1..1
            const y = baseline + v * (height * 0.35);
            if (i === 0) waveformCtx.moveTo(x, y); else waveformCtx.lineTo(x, y);
            x += slice;
          }
          waveformCtx.stroke();
        }

        hue = (hue + 2) % 360;
        wfId = requestAnimationFrame(drawWaveform);
      }

      // Disco lights (background reacts to music)
      function discoLoop() {
        if (!discoOn) return;
        if (analyser) {
          const freqArray = new Uint8Array(analyser.frequencyBinCount);
          analyser.getByteFrequencyData(freqArray);
          const n = Math.max(8, Math.floor(freqArray.length * 0.05));
          let sum = 0; for (let i = 0; i < n; i++) sum += freqArray[i];
          const level = (sum / n) / 255; // 0..1 approx bass level
          hue = (hue + 3 + level * 6) % 360;
          const sat = 70 + Math.floor(level * 30);
          const l1 = 20 + Math.floor(level * 20);
          const l2 = 40 + Math.floor(level * 25);
          document.body.style.background = `radial-gradient(circle at 25% 25%, hsl(${(hue) % 360}, ${sat}%, ${l2}%), transparent 60%),
                                            radial-gradient(circle at 75% 30%, hsl(${(hue + 120) % 360}, ${sat}%, ${l1}%), transparent 60%),
                                            radial-gradient(circle at 30% 75%, hsl(${(hue + 240) % 360}, ${sat}%, ${l2}%), transparent 60%),
                                            var(--bg)`;
        }
        discoId = requestAnimationFrame(discoLoop);
      }

      function startDisco() {
        ensureAC();
        if (!discoOn) return;
        cancelAnimationFrame(discoId);
        discoLoop();
      }
      function stopDisco() {
        cancelAnimationFrame(discoId);
        document.body.style.background = 'var(--bg)';
      }

      // Time helpers
      function toTime(secs) {
        if (!isFinite(secs)) return '00:00';
        const m = Math.floor(secs / 60).toString().padStart(2,'0');
        const s = Math.floor(secs % 60).toString().padStart(2,'0');
        return `${m}:${s}`;
      }

      // Playback
      async function togglePlay() {
        ensureAC();
        try { await audioContext.resume(); } catch(e) {}
        if (!audio.src) { window.alert('Please upload an audio file first.'); return; }
        if (isPlaying) {
          audio.pause();
          playPauseBtn.textContent = 'Play';
          albumPlayPauseBtn.textContent = 'Play';
          stopRotation();
          cancelAnimationFrame(wfId);
          if (discoOn) stopDisco();
        } else {
          await audio.play();
          playPauseBtn.textContent = 'Pause';
          albumPlayPauseBtn.textContent = 'Pause';
          rotateRecord();
          drawWaveform();
          if (discoOn) startDisco();
        }
        isPlaying = !isPlaying;
      }

      function stopAudio() {
        audio.pause();
        audio.currentTime = 0;
        playPauseBtn.textContent = 'Play';
        albumPlayPauseBtn.textContent = 'Play';
        isPlaying = false;
        cancelAnimationFrame(wfId);
        waveformCtx.clearRect(0, 0, waveformCanvas.width, waveformCanvas.height);
        stopRotation();
        if (discoOn) stopDisco();
      }

      // Events
      playPauseBtn.addEventListener('click', togglePlay);
      albumPlayPauseBtn.addEventListener('click', togglePlay);
      stopBtn.addEventListener('click', stopAudio);
      albumStopBtn.addEventListener('click', stopAudio);

      discoBtn.addEventListener('click', () => {
        discoOn = !discoOn;
        discoBtn.textContent = `Disco lights: ${discoOn ? 'On' : 'Off'}`;
        if (discoOn && isPlaying) startDisco(); else stopDisco();
      });

      rewindBtn.addEventListener('click', () => { audio.currentTime = Math.max(0, audio.currentTime - 10); });
      forwardBtn.addEventListener('click', () => { audio.currentTime = Math.min(audio.duration || 0, audio.currentTime + 10); });

      vol.addEventListener('input', () => { audio.volume = parseFloat(vol.value); });
      speed.addEventListener('input', () => { if (audio) audio.playbackRate = parseFloat(speed.value); });

      // Progress bar sync
      audio.addEventListener('timeupdate', () => {
        const d = audio.duration || 1; // avoid NaN
        progress.value = Math.floor((audio.currentTime / d) * 1000);
        timeReadout.textContent = `${toTime(audio.currentTime)} / ${toTime(d)}`;
      });
      progress.addEventListener('input', () => {
        const d = audio.duration || 1; audio.currentTime = (progress.value / 1000) * d;
      });

      // Uploads
      audioUpload.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        audio.src = url; audio.playbackRate = parseFloat(speed.value);
      });

      labelImageUpload.addEventListener('change', (e) => {
        const file = e.target.files?.[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
          label.style.backgroundImage = `url('${evt.target.result}')`;
          label.textContent = '';
        };
        reader.readAsDataURL(file);
      });

      albumCoverUpload.addEventListener('change', (e) => {
        const file = e.target.files?.[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => { albumImage.src = evt.target.result; };
        reader.readAsDataURL(file);
      });

      // Label resize
      resizeSlider.addEventListener('input', (e) => {
        const size = e.target.value; label.style.width = `${size}%`; label.style.height = `${size}%`; resizeValue.textContent = `${size}%`;
      });

      // Tabs
      function handleTabSwitch(tabName) {
        if (tabName === 'album') {
          waveformCanvas.width = waveformCanvas.clientWidth;
          waveformCanvas.height = waveformCanvas.clientHeight;
          if (isPlaying) drawWaveform();
        } else {
          cancelAnimationFrame(wfId);
        }
      }
      tabButtons.forEach(btn => btn.addEventListener('click', () => {
        const tabName = btn.getAttribute('data-tab');
        tabButtons.forEach(b => b.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(`${tabName}-tab`).classList.add('active');
        handleTabSwitch(tabName);
      }));

      // mode change re-triggers draw
      if (waveMode) waveMode.addEventListener('change', () => { if (isPlaying) { cancelAnimationFrame(wfId); drawWaveform(); } });

      // Init
      function onResize() {
        waveformCanvas.width = waveformCanvas.clientWidth;
        waveformCanvas.height = waveformCanvas.clientHeight;
      }
      window.addEventListener('resize', onResize);
      onResize();
    });
  </script>
</body>
</html>
